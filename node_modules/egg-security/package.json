{
  "_args": [
    [
      {
        "raw": "egg-security@^2.4.3",
        "scope": null,
        "escapedName": "egg-security",
        "name": "egg-security",
        "rawSpec": "^2.4.3",
        "spec": ">=2.4.3 <3.0.0",
        "type": "range"
      },
      "F:\\liuxin\\egg-project\\node_modules\\egg"
    ]
  ],
  "_from": "egg-security@^2.4.3",
  "_hasShrinkwrap": false,
  "_id": "egg-security@2.5.0",
  "_location": "/egg-security",
  "_nodeVersion": "10.15.2",
  "_npmOperationalInternal": {
    "host": "s3://npm-registry-packages",
    "tmp": "tmp/egg-security_2.5.0_1552010176335_0.7369662612989434"
  },
  "_npmUser": {
    "name": "fengmk2",
    "email": "fengmk2@gmail.com"
  },
  "_npmVersion": "6.5.0",
  "_phantomChildren": {},
  "_requested": {
    "raw": "egg-security@^2.4.3",
    "scope": null,
    "escapedName": "egg-security",
    "name": "egg-security",
    "rawSpec": "^2.4.3",
    "spec": ">=2.4.3 <3.0.0",
    "type": "range"
  },
  "_requiredBy": [
    "/egg"
  ],
  "_resolved": "https://registry.npmjs.org/egg-security/-/egg-security-2.5.0.tgz",
  "_shasum": "9fbbc322082c8c0159d553f834979d7c717be580",
  "_shrinkwrap": null,
  "_spec": "egg-security@^2.4.3",
  "_where": "F:\\liuxin\\egg-project\\node_modules\\egg",
  "author": {
    "name": "jtyjty99999"
  },
  "bugs": {
    "url": "https://github.com/eggjs/egg/issues"
  },
  "ci": {
    "version": "8, 10, 11"
  },
  "dependencies": {
    "csrf": "^3.0.6",
    "debug": "^4.1.1",
    "delegates": "^1.0.0",
    "egg-path-matching": "^1.0.0",
    "escape-html": "^1.0.3",
    "extend": "^3.0.1",
    "ip": "^1.1.5",
    "koa-compose": "^4.0.0",
    "matcher": "^1.1.1",
    "methods": "^1.1.2",
    "nanoid": "^2.0.1",
    "platform": "^1.3.4",
    "statuses": "^1.5.0",
    "type-is": "^1.6.15",
    "xss": "^1.0.3"
  },
  "description": "security plugin in egg framework",
  "devDependencies": {
    "autod": "^3.0.1",
    "beautify-benchmark": "^0.2.4",
    "benchmark": "^2.1.4",
    "egg": "^2.16.0",
    "egg-bin": "^4.3.5",
    "egg-ci": "^1.8.0",
    "egg-mock": "^3.13.1",
    "egg-view-nunjucks": "^2.1.4",
    "eslint": "^5.15.1",
    "eslint-config-egg": "^7.1.0",
    "mz-modules": "^2.1.0",
    "pedding": "^1.1.0",
    "rimraf": "^2.6.2",
    "should": "^13.1.3",
    "should-http": "^0.1.1",
    "spy": "^1.0.0",
    "supertest": "^3.0.0"
  },
  "directories": {},
  "dist": {
    "integrity": "sha512-lmny/cXmignIHC4S/l7EEd2nfDcvrPxpi4N1t6STSbUmgE4WVRc+eFQtKw9jEnJJOIobKyvQznH/Yi57f+VSCw==",
    "shasum": "9fbbc322082c8c0159d553f834979d7c717be580",
    "tarball": "https://registry.npmjs.org/egg-security/-/egg-security-2.5.0.tgz",
    "fileCount": 36,
    "unpackedSize": 69093,
    "npm-signature": "-----BEGIN PGP SIGNATURE-----\r\nVersion: OpenPGP.js v3.0.4\r\nComment: https://openpgpjs.org\r\n\r\nwsFcBAEBCAAQBQJcgcvBCRA9TVsSAnZWagAA8DYP/0ol/iyzSHaamMnblhj9\n3kGYFAmhfeW1mc6iyM/6NNVvSv8G9Ly2G3jlwx+iaC8qPDThhOVzsvyj6/sp\nYxJ8aobHbJK5CfDRAMBLRbIdyOuLpHcYgnAbtMLj8uFZ2fmr+xRcfjWvD0+O\nCLb85aDIbMMv4o2UOP5WFVUQjBtF8Fd8lSh/9RNhf4UvHEoaGJZSqDOQlfnz\nrhC/pU/hMon8xPjhq3nRnz0Y63gFVSbjjAVPRJnwlgAEkaOeS2ptzOC9BZUY\n5gf5vWW044GUVx4jeXkcFZr4dpa5lSY+ibaQ4ZDu2zfk/UrB0p3vll/WBvyI\nF+hv3cwuxtj8FaLWmBe74DLqDbV5VemQ7QfotBWlAKa2hwfugJBTJK+gdoqt\nWKxcULDhLR3u7lImxUzgRzE8Gy9upI1Adl5yZ7rZSJkHlFTQekD3BqddIrGv\n6Rp5eIYCmyfXBzaUyp7dNpSLs1vu9qJ/iBaB5yPiSaM3nMQHCh5VK97nOx5g\nvITntQZkr21dayp3ByzyMESMcBFHlXSUbyX4XEUm4XiEr4s+92eq4+9m6xeb\n1Dr9z/dIgJRddDE0leBbzm0m9qZMSwOHUit1XFeSpQy6nzmphUVY+KnMM4E9\nBUCVAcw/OLhDCviw8IF7s031fJ82g0B4v2o45zTX4MGvAO07zsYbtuPw6f2B\nTBQb\r\n=v49P\r\n-----END PGP SIGNATURE-----\r\n"
  },
  "eggPlugin": {
    "name": "security",
    "optionalDependencies": [
      "session"
    ]
  },
  "engines": {
    "node": ">=8.0.0"
  },
  "files": [
    "agent.js",
    "app",
    "lib",
    "config",
    "app.js",
    "index.js"
  ],
  "gitHead": "612d8783ec8368e8263b24e2ed3cda02dc591d33",
  "homepage": "https://github.com/eggjs/egg-security#readme",
  "keywords": [
    "egg",
    "eggPlugin",
    "egg-plugin",
    "security"
  ],
  "license": "MIT",
  "maintainers": [
    {
      "name": "atian25",
      "email": "atian25@qq.com"
    },
    {
      "name": "dead_horse",
      "email": "dead_horse@qq.com"
    },
    {
      "name": "eggjs",
      "email": "fengmk2+eggjs@gmail.com"
    },
    {
      "name": "fengmk2",
      "email": "fengmk2@gmail.com"
    },
    {
      "name": "jtyjty99999",
      "email": "jtyjty99999@126.com"
    },
    {
      "name": "popomore",
      "email": "sakura9515@gmail.com"
    },
    {
      "name": "shaoshuai0102",
      "email": "shaoshuai0102@gmail.com"
    }
  ],
  "name": "egg-security",
  "optionalDependencies": {},
  "readme": "# egg-security\n\nSecurity plugin in egg\n\n[![NPM version][npm-image]][npm-url]\n[![build status][travis-image]][travis-url]\n[![Test coverage][codecov-image]][codecov-url]\n[![David deps][david-image]][david-url]\n[![Known Vulnerabilities][snyk-image]][snyk-url]\n[![npm download][download-image]][download-url]\n\n[npm-image]: https://img.shields.io/npm/v/egg-security.svg?style=flat-square\n[npm-url]: https://npmjs.org/package/egg-security\n[travis-image]: https://img.shields.io/travis/eggjs/egg-security.svg?style=flat-square\n[travis-url]: https://travis-ci.org/eggjs/egg-security\n[codecov-image]: https://codecov.io/gh/eggjs/egg-security/branch/master/graph/badge.svg\n[codecov-url]: https://codecov.io/gh/eggjs/egg-security\n[david-image]: https://img.shields.io/david/eggjs/egg-security.svg?style=flat-square\n[david-url]: https://david-dm.org/eggjs/egg-security\n[snyk-image]: https://snyk.io/test/npm/egg-security/badge.svg?style=flat-square\n[snyk-url]: https://snyk.io/test/npm/egg-security\n[download-image]: https://img.shields.io/npm/dm/egg-security.svg?style=flat-square\n[download-url]: https://npmjs.org/package/egg-security\n\nEgg's default security plugin, generally no need to configure.\n\n## Install\n\n```bash\n$ npm i egg-security\n```\n\n## Usage & configuration\n\n- `config.default.js`\n\n```js\nexports.security = {\n  xframe: {\n    value: 'SAMEORIGIN',\n  },\n};\n```\n\n### Disable security precautions\n\nIf you want to disable some security precautions, set `enable` porperty to 'false' directly.\n\nFor example, disable xframe defense:\n\n```js\nexports.security = {\n  xframe: {\n    enable: false,\n  },\n};\n```\n\n### match & ignore\n\nIf you want to set security config open for a certain path, you can configure `match` option.\n\nFor example, just open csp when path contains `/example`, you can configure with the following configuration:\n\n```js\nexports.security = {\n  csp: {\n    match: '/example',\n    policy: {\n      //...\n    },\n  },\n};\n\n```\n\nIf you want to set security config disable for a certain path, you can configure `match` option.\n\nFor example, just disable xframe when path contains `/example` while our pages can be embedded in cooperative businesses , you can configure with the following configuration:\n\n```js\nexports.security = {\n  csp: {\n    ignore: '/example',\n    xframe: {\n      //...\n    },\n  },\n};\n\n```\n\n__mention：`match` has higher priority than `ignore`__\n\n### Dynamic configuration for security plugins depend on context\n\nThere are times when we want to be more flexible to configure security plugins.For example:\n\n1. To decide whether to enable or disable the xframe security header from the context of the request.\n2. To decide csp policies from different request urls.\n\nThen we can configure `ctx.securityOptions[name] opts` in the custom middleware or controller,then the current request configuration will overrides the default configuration (new configuration will be merged and override the default project configuration, but only take effect in the current request)\n\n```js\nasync ctx => {\n  // if satisfied some condition\n  // change configuration\n  ctx.securityOptions.xframe = {\n    value: 'ALLOW-FROM: https://domain.com',\n  };\n  // disable configuration\n  ctx.securityOptions.xssProtection = {\n    enable: false,\n  }\n}\n```\n\nNot all security plugins support dynamic configuration, only following plugins list support\n\n- csp\n- hsts\n- noopen\n- nosniff\n- xframe\n- xssProtection\n\nAnd in ` helper `：\n\n- shtml\n\nhelper is the same way to configure.\n\n```js\nctx.securityOptions.shtml = {\n  whiteList: {\n  },\n};\n```\n\n#### Mention\n\n- Security is a big thing, please pay attention to the risk of changes in the security configuration (especially dynamic changes)\n- `ctx.securityOptions` the current request configuration will overrides the default configuration, but it does not make a deep copy，so pay attention to configure `csp.policy`, it will not be merged.\n- If you configure `ctx.securityOptions`，please write unit tests to ensure the code is correct.\n\n\n## API\n\n### ctx.isSafeDomain(domain)\n\nWhether or not the domain is in the whitelist of the configuration. See `ctx.redirect`.\n\nNote: [egg-cors](https://github.com/eggjs/egg-cors) module uses this function internally to determine whether or not send back an `Access-Control-Allow-Origin` response header with the value of safe domain. Otherwise, ignore the request with an error, `No 'Access-Control-Allow-Origin' header is present on the requested resource.`\n\n```js\nexports.security = {\n  domainWhiteList: ['http://localhost:4200']\n};\n```\n\n## Interface restriction\n\n### CSRF\n\n__usage__\n\n* `ctx.csrf` getter for CSRF token\n\nGenerally used when send POST form request. When page rendering, put `ctx.csrf` into form hidden field or query string.(`_csrf` is the key).\nWhen submitting the form, please submit with the `_csrf` token parameter.\n\n#### Using CSRF when upload by formData\n\nbrowser:\n\n```html\n<form method=\"POST\" action=\"/upload?_csrf={{ ctx.csrf | safe }}\" enctype=\"multipart/form-data\">\n  title: <input name=\"title\" />\n  file: <input name=\"file\" type=\"file\" />\n  <button type=\"submit\">上传</button>\n</form>\n```\n\n#### Using CSRF when request by AJAX\n\nCSRF token will also set to cookie by default, and you can send token through header:\n\nIn jQuery:\n\n```js\nvar csrftoken = Cookies.get('csrftoken');\n\nfunction csrfSafeMethod(method) {\n  // these HTTP methods do not require CSRF protection\n  return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));\n}\n$.ajaxSetup({\n  beforeSend: function(xhr, settings) {\n    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {\n      xhr.setRequestHeader('x-csrf-token', csrftoken);\n    }\n  },\n});\n```\n\n#### Options\n\nthere are some options that you can customize:\n\n```js\nexports.security = {\n  csrf: {\n    useSession: false,          // if useSession set to true, the secret will keep in session instead of cookie\n    ignoreJSON: false,          // skip check JSON requests if ignoreJSON set to true\n    cookieName: 'csrfToken',    // csrf token's cookie name\n    sessionName: 'csrfToken',   // csrf token's session name\n    headerName: 'x-csrf-token', // request csrf token's name in header\n    bodyName: '_csrf',          // request csrf token's name in body\n    queryName: '_csrf',         // request csrf token's name in query\n  },\n}\n```\n\n#### Rotate CSRF secret\n\nMust call `ctx.rotateCsrfSecret()` when user login to ensure each user has independent secret.\n\n### safe redirect\n\n* `ctx.redirect(url)` If url is not in the configuration of the white list, the redirect will be prohibited\n\n* `ctx.unsafeRedirect(url)` Not Recommended;\n\nSecurity plugin override `ctx.redirect` method，all redirects will be judged by the domain name.\n\nIf you need to use `ctx.redirect`, you need to do the following configuration in the application configuration file：\n\n```js\nexports.security = {\n  domainWhiteList:['.domain.com'],  // security whitelist, starts with '.'\n};\n```\n\nIf user do not configure `domainWhiteList` or `domainWhiteList` is empty, it will pass all redirects, equal to `ctx.unsafeRedirect(url)`. `domainWhiteList` and `url` are case insensitive.\n\n### jsonp\n\nBased on [jsonp-body](https://github.com/node-modules/jsonp-body).\n\nDefense:\n\n* The longest callback function name limit of 50 characters.\n* Callback function only allows \"[\",\"]\",\"a-zA-Z0123456789_\", \"$\" \".\" to prevent `xss` or `utf-7` attack.\n\nConfig：\n\n* callback function default name `_callback`.\n* limit - function name limit, default by 50.\n\n## helper\n\n### .escape()\n\nString xss filter, the most secure filtering mechanism.\n\n```js\nconst str = '><script>alert(\"abc\") </script><';\nconsole.log(ctx.helper.escape(str));\n// => &gt;&lt;script&gt;alert(&quot;abc&quot;) &lt;/script&gt;&lt;\n```\n\nIn nunjucks template, escape by default.\n\n### .surl()\n\nurl filter.\n\nUsed for url in html tags (like `<a href=\"\"/><img src=\"\"/>`),please do not call under other places.\n\n  `helper.surl($value)`。\n\n** Mention: Particular attention, if you need to resolve URL use `surl`，`surl` need warpped in quotes, Otherwise will lead to XSS vulnerability.**\n\nExample: do not use surl\n\n```html\n<a href=\"$value\" />\n```\n\noutput:\n\n```html\n<a href=\"http://ww.domain.com<script>\" />\n```\n\nUse surl\n\n```html\n<a href=\"helper.surl($value)\" />\n```\n\noutput:\n\n```html\n<a href=\"http://ww.domain.com&lt;script&gt;\" />\n```\n\n#### protocolWhitelist\n\nIf url's protocol is not in the protocol whitelist, it will return empty string.\n\nProtocol whitelist is `http`, `https`, `file`, `data`.\n\nSo if you want `surl` support custom protocol, please extend the security `protocolWhitelist` config :\n\n```js\nexports.security = {\n  protocolWhitelist: ['test']\n};\n```\n\n### .sjs()\n\nUsed to output variables in javascript(include onload/event),it will do `JAVASCRIPT ENCODE` for the variable string.It will escape all characters to `\\x` which are not in the whitelist to avoid XSS attack.\n\n```js\nconst foo = '\"hello\"';\n\n// not use sjs\nconsole.log(`var foo = \"${foo}\";`);\n// => var foo = \"\"hello\"\";\n\n// use sjs\nconsole.log(`var foo = \"${ctx.helper.sjs(foo)}\";`);\n// => var foo = \"\\\\x22hello\\\\x22\";\n```\n\n### .shtml()\n\nIf you want to output richtexts in views, you need to use `shtml` helper.\nIt will do XSS filter, then output html tags to avoid illegal scripts.\n\n** shtml is a very complex process, it will effect server performance, so if you do not need to output HTML, please do not use shtml.**\n\nExamples:\n\n```js\n// js\nconst value = `<a href=\"http://www.domain.com\">google</a><script>evilcode…</script>`;\n\n// in your view\n<html>\n<body>\n  ${helper.shtml($value)}\n</body>\n</html>\n// => <a href=\"http://www.domain.com\">google</a>&lt;script&gt;evilcode…&lt;/script&gt;\n```\n\nshtml based on [xss](https://github.com/leizongmin/js-xss/), and add filter by domain feature.\n\n- [default rule](https://github.com/leizongmin/js-xss/blob/master/lib/default.js)\n- custom rule http://jsxss.com/zh/options.html\n\nFor example, only support `a` tag, and filter all attributes except for `title`: \n\n```javascript\nwhiteList: {a: ['title']}\n```\n\noptions:\n\n> `config.helper.shtml.domainWhiteList` has been deprecated, please use `config.security.domainWhiteList` instead.\n\nMention that `shtml` uses a strict white list mechanism, in addition to filtering out the XSS risk of the string,`tags` and `attrs` which are not in the [default rule](https://github.com/leizongmin/js-xss/blob/master/lib/default.js) will be filtered.\n\nFor example `html` tag is not in the whitelist.\n\n```js\nconst html = '<html></html>';\n\n// html\n${helper.shtml($html)}\n\n// output none\n```\n\nCommonly used `data-xx` property is not in the whitelist, so it will be filtered.\nSo please check the applicable scenarios for `shtml`, it usually used for richtext submmited by user.\n\nA usage error will limit functions, also affect the performance of the server.\nSuch scenes are generally forums, comments, etc.\n\nEven if the forum does not support the HTML content input, do not use this helper, you can directly use `escape` instead.\n\n### .spath()\n\nIf you want to use users input for a file path, please use spath for security check. If path is illegal, it will return null.\n\nIllegal path:\n\n- relative path starts with `..`\n- absolute path starts with `/`\n- above path try to use `url encode` to bypass the check\n\n```js\nconst foo = '/usr/local/bin';\nconsole.log(ctx.helper.spath(foo2));\n// => null\n```\n\n### .sjson()\n\njson encode.\n\nIf you want to output json in javascript without encoding, it will be a risk for XSS.\nsjson supports json encode，it will iterate all keys in json, then escape all characters in the value to `\\x` to avoid XSS attack, and keep the json structure unchanged.\nIf you want to output json string in your views, please use `${ctx.helper.sjson(var)}`to escape.\n\n**it has a very complex process and will lost performance, so avoid the use as far as possible**\n\nexample:\n\n```js\n  <script>\n    window.locals = ${ctx.helper.sjson(locals)};\n  </script>\n```\n\n### .cliFilter()\n\nIt will cause remote command execution vulnerability, when user submit the implementation of the command by browser.because the server does not filter for the implementation of the function, resulting in the execution of the command can usually lead to the invasion of the server.\n\nIf you want to get user submit for command's parameter, please use `cliFilter`。\n\nbefore fix:\n\n```js\n\n  cp.exec(\"bash /home/admin/ali-knowledge-graph-backend/initrun.sh \" + port);\n\n```\n\nafter fix:\n\n```js\n\n  cp.exec(\"bash /home/admin/ali-knowledge-graph-backend/initrun.sh \" + ctx.helper.cliFilter(port));\n\n```\n\n## Security Headers\n\nRefer to [lusca](https://github.com/krakenjs/lusca), appriciate for their works.\n\n### hsts Strict-Transport-Security\n\nDisabled by default. If your website based on https, we recommend you should enable it.\n\n- maxAge one year by default `365 * 24 * 3600`\n- includeSubdomains false by default\n\n\n### csp\n\nDefault disabled. If you need to enable, please contact your security engineers and determine the opening strategy\n\n- policy policies used by csp\n\n### X-Download-Options:noopen\n\nDefault enabled, disable IE download dialog automatically open download file and will cause XSS\n\n### X-Content-Type-Options:nosniff\n\nDisable IE8's auto MIME sniffing. E.g: take `text/plain` as `text/html` by mistake and render it, especially when there's something untrusted in the local service.\n\n### X-Frame-Options\n\nDefaulting to \"SAMEORIGIN\", only allow iframe embed by same origin.\n\n- value Defaulting to `SAMEORIGIN`\n\n### X-XSS-Protection\n\n- disable Defaulting to `false`，same as `1; mode=block`.\n\n### SSRF Protection\n\nIn a [Server-Side Request Forgery (SSRF)](https://www.owasp.org/index.php/Server_Side_Request_Forgery) attack, the attacker can abuse functionality on the server to read or update internal resources.\n\n`egg-security` provide `ctx.safeCurl`, `app.safeCurl` and `agent.safeCurl` to provide http request(like `ctx.curl`, `app.curl` and `agent.curl`) with SSRF protection.\n\n#### Configuration\n\n* ipBlackList(Array) - specific which ip are illegal when request with `safeCurl`.\n* checkAddress(Function) - determine the ip by the function's return value, `false` means illegal ip.\n\n```js\n// config/config.default.js\nexports.security = {\n  ssrf: {\n    // support both cidr subnet or specific ip\n    ipBlackList: [\n      '10.0.0.0/8',\n      '127.0.0.1',\n      '0.0.0.0/32',\n    ],\n    // checkAddress has higher priority than ipBlackList\n    checkAddress(ip) {\n      return ip !== '127.0.0.1';\n    }\n  },\n};\n```\n\n## Other\n\n* Forbid `trace` `track` http methods.\n\n## License\n\n[MIT](https://github.com/eggjs/egg-security/blob/master/LICENSE)\n",
  "readmeFilename": "README.md",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/eggjs/egg-security.git"
  },
  "scripts": {
    "autod": "autod",
    "ci": "npm run lint && npm run cov",
    "cov": "egg-bin cov",
    "lint": "eslint .",
    "test": "npm run lint -- --fix && npm run test-local",
    "test-local": "egg-bin test"
  },
  "version": "2.5.0"
}
